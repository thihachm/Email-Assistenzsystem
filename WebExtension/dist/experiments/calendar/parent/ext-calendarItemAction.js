ChromeUtils.defineModuleGetter(this,"ToolbarButtonAPI","resource:///modules/ExtensionToolbarButtons.jsm"),ChromeUtils.defineModuleGetter(this,"ExtensionParent","resource://gre/modules/ExtensionParent.jsm"),ChromeUtils.defineModuleGetter(this,"ExtensionSupport","resource:///modules/ExtensionSupport.jsm");var{ExtensionCommon}=ChromeUtils.import("resource://gre/modules/ExtensionCommon.jsm"),{makeWidgetId}=ExtensionCommon;const calendarItemActionMap=new WeakMap;this.calendarItemAction=class extends ToolbarButtonAPI{static for(e){return calendarItemActionMap.get(e)}onStartup(){let e=this.extension.manifest?.calendar_item_action;if(e){let t=this.extension.localize.bind(this.extension);e.default_popup&&(e.default_popup=this.extension.getURL(t(e.default_popup))),e.default_label&&(e.default_label=t(e.default_label)),e.default_title&&(e.default_title=t(e.default_title)),this.onManifestEntry("calendar_item_action")}ExtensionSupport.registerWindowListener("ext-calendar-itemAction-"+this.extension.id,{chromeURLs:["chrome://calendar/content/calendar-event-dialog.xhtml"],onLoadWindow:function(e){let{document:t}=e;if(!t.getElementById("mainPopupSet")){let e=t.createElementNS("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul","popupset");e.id="mainPopupSet";let n=t.querySelector("dialog");n.insertBefore(e,n.firstElementChild)}}})}async onManifestEntry(e){await super.onManifestEntry(e),calendarItemActionMap.set(this.extension,this),"ADDON_INSTALL"==this.extension.startupReason&&this.addToCurrentSet("chrome://messenger/content/messenger.xhtml","event-tab-toolbar")}addToCurrentSet(e,t){let n=Services.xulStore.getValue(e,t,"currentset");n&&(n=n.split(","),n.includes(this.id)||(n.push(this.id),Services.xulStore.setValue(e,t,"currentset",n.join(","))))}close(){super.close(),calendarItemActionMap.delete(this.extension)}constructor(e){super(e,ExtensionParent.apiManager.global),this.manifest_name="calendar_item_action",this.manifestName="calendarItemAction",this.windowURLs=["chrome://messenger/content/messenger.xhtml","chrome://calendar/content/calendar-event-dialog.xhtml"],this.toolboxId="event-toolbox",this.toolbarId="event-toolbar"}paint(e){return"chrome://calendar/content/calendar-event-dialog.xhtml"==e.location.href?this.toolbarId="event-toolbar":this.toolbarId="event-tab-toolbar",super.paint(e)}handleEvent(e){super.handleEvent(e);let t=e.target.ownerGlobal;switch(e.type){case"popupshowing":{const n=e.target,o=n.triggerNode,i=t.document.getElementById(this.id);["event-dialog-toolbar-context-menu"].includes(n.id)&&i&&i.contains(o)&&global.actionContextMenu({tab:t,pageUrl:t.browser.currentURI.spec,extension:this.extension,onComposeAction:!0,menu:n});break}}}onShutdown(){let e=this.extension.id;ExtensionSupport.unregisterWindowListener("ext-calendar-itemAction-"+e);let t=`${makeWidgetId(e)}-calendarItemAction-toolbarbutton`,n=["chrome://messenger/content/messenger.xhtml","chrome://calendar/content/calendar-event-dialog.xhtml"];for(let e of n){let n=Services.xulStore.getValue(e,"event-toolbar","currentset");n=n.split(",");let o=n.indexOf(t);o>=0&&(n.splice(o,1),Services.xulStore.setValue(e,"event-toolbar","currentset",n.join(",")))}}},global.calendarItemActionFor=this.calendarItemAction.for;